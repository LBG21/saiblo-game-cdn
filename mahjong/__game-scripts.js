const tingpai=Logic.cwrap("ting_pai","string",["string","number","number","string","boolean","string"]);const DEBUG=!1,OFFLINE=0,ONLINE=1,SPECTATOR=2;let gameMode=0;function startWebSocket(e,s,t){const o=new WebSocket((t?"wss://":"ws://")+e);return o.onopen=()=>{console.log("Connection open..."),gameMode=1,o.send(JSON.stringify({request:"connect",token:s}))},o.onmessage=e=>{const{request:s,content:t}=JSON.parse(e.data);"action"===s&&parseOnline(t)},o.onclose=()=>{console.log("Connection close")},e=>{e.time=timeElapsed>5?timeElapsed-5:0,o.send(JSON.stringify({request:"action",token:s,content:JSON.stringify(e)}))}}let sendMsg=e=>{console.log("WebSocket not open yet.")};{const e="127.0.0.1:9010/1/Aglove/1";sendMsg=startWebSocket(e,btoa(e),!1)}let notifyCanvasHeight=e=>{0};function readMsg(e){const s=e.data;if(notifyCanvasHeight=s=>{e.source.postMessage({message:"resized",height:s},e.origin)},"init_replay_player"===s.message){gameMode=0;const t=new FileReader;t.onloadend=()=>{parseOffline(t.result,(s=>{e.source.postMessage({message:"init_successfully",number_of_frames:s},e.origin)}))},t.readAsText(s.replay_data)}else"load_frame"===s.message?loadFrame(s.index):"load_next_frame"===s.message?loadNextFrame():"init_player_player"===s.message?(gameMode=1,sendMsg=startWebSocket(atob(s.token),s.token,!0)):"init_spectator_player"===s.message&&(gameMode=2)}let replay=[],observerId=0,currFrame=0;function parseOffline(r,e){replay=JSON.parse(r),e(replay.length),currFrame=0,loadFrame(0)}function loadNextFrame(){++currFrame,drawFrameFromDiff(currFrame)}function loadFrame(r){currFrame=r,drawFrame(r)}function parseOnline(e){switch((e=JSON.parse(e)).type){case 0:onlineInit(e.info);break;case 1:newTile(e.tile);break;case 2:opponentAction(e.actionPlayer,e.actionType,e.actionPayload,e.moqie);break;case 3:revealDora(e.tile);break;case 4:prepareAction(e.valid,e);break;case 5:handleOver(e.info);break;case 6:lizhi(e.player);break;case 7:handleZhenting(e.is_zhenting)}}const Root=pc.createScript("root");var rootInst,screenInst,actionsInst,tilesInst,zhentingImg,tingpaiHint,tingpaiBack,wuyiImg,fanImg,fanNumSprite,opponentTiles,discardedRoots,exposedRoots,lizhibangRoot,changFengInst,juNumInst,fengRoots,pointsInsts,scoreSprite,leftTensInst,leftOnesInst,countdownInst,defaultFont,zhentingFont,tileTemplate,actionsSprite,tilesFor2d,tilesFor3d,doraBoard,jibang0,jibang1,benchang0,benchang1,resultScreen,pointsDiff,tingPaiRoot,huangpaiPic,tempTpBg,tempTpRoot,yiTextL,yiTextR,yiTextX,huPaiXingRoot,liDoraRoot,liDoraText,pointsNumInst,centerCollider,fuFanRoot,yakumanWord,yakumanChars,selectImg,selectRoot,cameraRoot,bgmSlots;Root.attributes.add("root",{type:"entity"}),Root.attributes.add("screen",{type:"entity"}),Root.attributes.add("actions",{type:"entity"}),Root.attributes.add("tiles",{type:"entity"}),Root.attributes.add("zhenting",{type:"entity"}),Root.attributes.add("tingpaiHint",{type:"entity"}),Root.attributes.add("tingpaiBack",{type:"entity"}),Root.attributes.add("wuyiImg",{type:"asset"}),Root.attributes.add("fanImg",{type:"asset"}),Root.attributes.add("fanNumSprite",{type:"asset"}),Root.attributes.add("opponentTilesRoot",{type:"entity"}),Root.attributes.add("discarded",{type:"entity",array:!0}),Root.attributes.add("exposed",{type:"entity",array:!0}),Root.attributes.add("lizhibangRoot",{type:"entity"}),Root.attributes.add("feng",{type:"entity",array:!0}),Root.attributes.add("changFeng",{type:"entity"}),Root.attributes.add("juNum",{type:"entity"}),Root.attributes.add("leftOnes",{type:"entity"}),Root.attributes.add("leftTens",{type:"entity"}),Root.attributes.add("points",{type:"entity",array:!0}),Root.attributes.add("scoreSprite",{type:"asset"}),Root.attributes.add("countdown",{type:"entity"}),Root.attributes.add("font",{type:"asset"}),Root.attributes.add("zhentingFont",{type:"asset"}),Root.attributes.add("tileTemplate",{type:"asset"}),Root.attributes.add("actionsSprite",{type:"asset"}),Root.attributes.add("tilesFor2d",{type:"asset"}),Root.attributes.add("tilesFor3d",{type:"asset"}),Root.attributes.add("doraBoard",{type:"entity"}),Root.attributes.add("changgongNums",{type:"entity",array:!0}),Root.attributes.add("resultScreen",{type:"entity"}),Root.attributes.add("pointsDiff",{type:"entity"}),Root.attributes.add("tingpai",{type:"entity"}),Root.attributes.add("huangpaiPic",{type:"entity"}),Root.attributes.add("tempTpBg",{type:"entity"}),Root.attributes.add("tempTpRoot",{type:"entity"}),Root.attributes.add("yiTextL",{type:"entity"}),Root.attributes.add("yiTextR",{type:"entity"}),Root.attributes.add("yiTextX",{type:"entity"}),Root.attributes.add("huPaiXingRoot",{type:"entity"}),Root.attributes.add("liDoraRoot",{type:"entity"}),Root.attributes.add("liDoraText",{type:"entity"}),Root.attributes.add("pointsNumInst",{type:"asset"}),Root.attributes.add("centerCollider",{type:"entity"}),Root.attributes.add("fuFan",{type:"entity"}),Root.attributes.add("yakumanWord",{type:"entity"}),Root.attributes.add("yakumanChars",{type:"entity"}),Root.attributes.add("selectImg",{type:"entity"}),Root.attributes.add("selectRoot",{type:"entity"}),Root.attributes.add("cameras",{type:"entity"}),Root.attributes.add("bgm",{type:"entity"}),Root.prototype.initialize=function(){rootInst=this.root,screenInst=this.screen,actionsInst=this.actions,tilesInst=this.tiles,tingpaiHint=this.tingpaiHint,tingpaiBack=this.tingpaiBack,wuyiImg=this.wuyiImg,fanImg=this.fanImg,fanNumSprite=this.fanNumSprite,zhentingImg=this.zhenting,opponentTiles=[void 0].concat(this.opponentTilesRoot.children),discardedRoots=this.discarded,exposedRoots=this.exposed,lizhibangRoot=this.lizhibangRoot,fengRoots=this.feng,changFengInst=this.changFeng,juNumInst=this.juNum,leftTensInst=this.leftTens,leftOnesInst=this.leftOnes,pointsInsts=this.points,scoreSprite=this.scoreSprite,countdownInst=this.countdown,defaultFont=this.font,zhentingFont=this.zhentingFont,tileTemplate=this.tileTemplate,actionsSprite=this.actionsSprite,tilesFor2d=this.tilesFor2d,tilesFor3d=this.tilesFor3d,doraBoard=this.doraBoard,[jibang0,jibang1,benchang0,benchang1]=this.changgongNums,resultScreen=this.resultScreen,pointsDiff=this.pointsDiff,tingPaiRoot=this.tingpai,huangpaiPic=this.huangpaiPic,tempTpBg=this.tempTpBg,tempTpRoot=this.tempTpRoot,yiTextL=this.yiTextL,yiTextR=this.yiTextR,yiTextX=this.yiTextX,huPaiXingRoot=this.huPaiXingRoot,liDoraRoot=this.liDoraRoot,liDoraText=this.liDoraText,pointsNumInst=this.pointsNumInst,centerCollider=this.centerCollider,fuFanRoot=this.fuFan,yakumanWord=this.yakumanWord,yakumanChars=this.yakumanChars.children,selectImg=this.selectImg,selectRoot=this.selectRoot,cameraRoot=this.cameras,bgmSlots=this.bgm.sound.slots,tingpaiBack.element.on("click",(()=>{tempTpBg.enabled=!1,tempTpRoot.enabled=!1,tingpaiBack.enabled=!1}))};const Countdown=pc.createScript("countdown"),DEFAULT_COUNTDOWN=5;let timeElapsed=0;Countdown.attributes.add("short",{type:"entity"}),Countdown.attributes.add("plus",{type:"entity"}),Countdown.attributes.add("tens",{type:"entity"}),Countdown.attributes.add("ones",{type:"entity"}),Countdown.prototype.updateUI=function(t,e){0===t?(this.short.enabled=!1,this.plus.enabled=!1,this.tens.enabled=e>=10,this.ones.enabled=!0,this.tens.setLocalPosition(315,-100,0),this.ones.setLocalPosition(363,-100,0),this.tens.element.spriteFrame=Math.floor(e/10),this.ones.element.spriteFrame=e%10):(this.short.enabled=!0,this.plus.enabled=!0,this.tens.enabled=!0,this.ones.enabled=e>=10,this.short.setLocalPosition(315,-100,0),this.plus.setLocalPosition(363,-100,0),this.tens.setLocalPosition(411,-100,0),this.ones.setLocalPosition(459,-100,0),this.short.element.spriteFrame=t,this.tens.element.spriteFrame=e>9?Math.floor(e/10):e,this.ones.element.spriteFrame=e%10)},Countdown.prototype.clearUI=function(){this.short.enabled=!1,this.plus.enabled=!1,this.tens.enabled=!1,this.ones.enabled=!1},Countdown.prototype.initialize=function(){this.clearUI(),this.entity.on("set",((t,e)=>{let s=5;timeElapsed=0,this.updateUI(s,t),this.currentTimer=setInterval((()=>{s+t>0&&(++timeElapsed,s>0?--s:--t,this.updateUI(s,t),s+t<=5&&s+t>=1?bgmSlots.CountDown5.play():s+t===0&&(this.clearUI(),e()))}),1e3)})),this.entity.on("unset",(()=>{this.clearUI(),clearInterval(this.currentTimer)}))};const tileEqual=(e,r)=>e===r||e[1]===r[1]&&"z"!==e[1]&&("5"===e[0]&&"0"===r[0]||"0"===e[0]&&"5"===r[0]),batchSlice=e=>Array.from(new Array(e.length/2),((r,t)=>e.slice(2*t,2*(t+1)))),splitMatch=e=>{if("A"===e[0]){const r=e.slice(1);return["5"===r[0]&&"z"!==r[1]?"0"+r[1]:r,r,r,r]}return r=e.slice(1).replaceAll("$",""),Array.from(new Array(r.length/2),((e,t)=>r.slice(2*t,2*(t+1))));var r},lizhiIncluded=(e,r)=>e.some((e=>{return(t=e)===(c=r)||t[1]===c[1]&&"z"!==t[1]&&("5"===t[0]&&"0"===c[0]||"0"===t[0]&&"5"===c[0]);var t,c})),tileToIndex=e=>{if(""===e)return 37;let r;switch(e[1]){case"m":r=0;break;case"p":r=10;break;case"s":r=20;break;case"z":r=30}return r+Number(e[0])},tileToSeq=e=>{switch(e){case"0m":return 5;case"0p":return 15;case"0s":return 25;default:return tileToIndex(e)}},nextTile=e=>{switch(e){case"0m":return"6m";case"0p":return"6p";case"0s":return"6s";case"9m":return"1m";case"9p":return"1p";case"9s":return"1s";case"3z":return"0z";case"6z":return"4z";default:return String(Number(e[0])+1)+e[1]}},isRed=e=>"0m"===e||"0p"===e||"0s"===e,naiveSlice=e=>4===e.length?[e.slice(0,2),e.slice(2)]:[e.slice(0,2),e.slice(2,4),e.slice(4)];function createTile(e,r,{dimension:t,isDoraSign:c},l){switch(t){case 2:{const t=new pc.Entity(r);t.addComponent("element",{type:"image",sprite:tilesFor2d.resource,useInput:!0}),t.element.spriteFrame=tileToIndex(r),c?t.setLocalScale(1.3,2.1,1):t.setLocalScale(1.6,2.6,1),e.addChild(t),l&&t.element.on("click",l);const n={same:!1,dora:!1,active:!1,moqie:!1};return t.on("highlight",((e,r)=>{n[e]=r,n.active?t.element.color=pc.Color.RED:n.dora?t.element.color=new pc.Color(1,1,.6,1):n.same?t.element.color=new pc.Color(0,.8,0,1):t.element.color=pc.Color.WHITE})),t}case 3:{const t=tileTemplate.resource.instantiate();t.name=r,t.children[0].sprite.frame=tileToIndex(r),""===r&&t.rotateLocal(180,0,0),e.addChild(t),l&&t.on("click",l);const c={same:!1,dora:!1,active:!1,moqie:!1};return t.on("highlight",((e,r)=>{c[e]=r,c.active?t.children[0].sprite.color=pc.Color.RED:c.dora?t.children[0].sprite.color=new pc.Color(1,1,.6,1):c.same?t.children[0].sprite.color=new pc.Color(0,.8,0,1):c.moqie?t.children[0].sprite.color=new pc.Color(.7,.7,.7,1):t.children[0].sprite.color=pc.Color.WHITE})),t}}}const yiDict={lizhi:"立直",duanyaojiu:"断幺九",menqianqingzimohu:"门前清自摸和",yipai_bai:"役牌：白",yipai_fa:"役牌：发",yipai_zhong:"役牌：中",yipai_zifeng:"役牌：自风",yipai_changfeng:"役牌：场风",pinghu:"平和",yibeikou:"一杯口",qianggang:"枪杠",lingshangkaihua:"岭上开花",haidimoyue:"海底摸月",hedimoyu:"河底摸鱼",yifa:"一发",baopai:"宝牌",hongbaopai:"红宝牌",libaopai:"里宝牌",lianglizhi:"两立直",sansetongke:"三色同刻",sangangzi:"三杠子",duiduihu:"对对和",sananke:"三暗刻",xiaosanyuan:"小三元",hunlaotou:"混老头",qiduizi:"七对子",hunquandaiyaojiu:"混全带幺九",yiqitongguan:"一气通贯",sansetongshun:"三色同顺",erbeikou:"二杯口",chunquandaiyaojiu:"纯全带幺九",hunyise:"混一色",liujumanguan:"流局满贯",qingyise:"清一色",tianhu:"天和",dihu:"地和",dasanyuan:"大三元",sianke:"四暗刻",ziyise:"字一色",lvyise:"绿一色",qinglaotou:"清老头",guoshiwushuang:"国士无双",xiaosixi:"小四喜",sigangzi:"四杠子",jiulianbaodeng:"九莲宝灯",siankedanqi:"四暗刻单骑",guoshiwushuangshisanmian:"国士无双十三面",chunzhengjiulianbaodeng:"纯正九莲宝灯",dasixi:"大四喜"};function destroyChildren(e){for(;e.children.length>0;)e.children[0].destroy()}function rotateY(e,t){switch(t){case 0:return e;case 1:return new pc.Vec3(e.z,e.y,-e.x);case 2:return new pc.Vec3(-e.x,e.y,-e.z);case 3:return new pc.Vec3(-e.z,e.y,e.x)}}function visualizeFeng(e,t){for(let i=0;i<4;++i)fengRoots[i].sprite.frame=(t-e+i+16)%4}function clearActions(e){destroyChildren(actionsInst),e&&bgmSlots.BtnCancel.play()}function sameTile(e,t="same"){for(let i=0;i<4;++i){for(const n of discardedRoots[i].children)("same"===t||tileEqual(e,n.name))&&n.fire("highlight",t,tileEqual(e,n.name));for(const n of exposedRoots[i].children)("same"===t||tileEqual(e,n.name))&&n.fire("highlight",t,tileEqual(e,n.name))}if("dora"===t)for(const i of tilesInst.children)tileEqual(e,i.name)&&i.fire("highlight",t,!0)}function clearTile(){for(let e=0;e<4;++e){for(const t of discardedRoots[e].children)t.fire("highlight","same",!1);for(const t of exposedRoots[e].children)t.fire("highlight","same",!1)}}function drawMyTiles(e,t,i=info.myId){let n=-1;const o=(i-info.myId+4)%4;if(0!==o&&gameMode===ONLINE)return;destroyChildren(0===o?tilesInst:opponentTiles[o]),e.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const a=t?e.concat([void 0,t]):e;tempTpBg.enabled=!1,tempTpRoot.enabled=!1,tingpaiBack.enabled=!1;for(let s=0;s<a.length;++s){if(void 0===a[s])continue;const l=void 0!==t&&s===a.length-1;if(i===info.myId){const i=createTile(tilesInst,a[s],{dimension:2},(()=>{if(n===s||void 0!==t&&n===a.length-2&&s===a.length-1?!states.canDiscard||states.toLizhi&&!lizhiIncluded(states.canLizhi,a[s])?(tilesInst.children[n].translateLocal(0,-30,0),n=-1,clearTile()):(sendMsg({type:states.toLizhi?"lizhi":"qiepai",payload:a[s],moqie:l}),discard(info.myId,a[s],l,states.toLizhi,void 0===t),states.canDiscard=!1,countdownInst.fire("unset"),clearActions(!1),clearTile()):(-1!==n&&tilesInst.children[n].translateLocal(0,-30,0),n=void 0!==t&&s===a.length-1?a.length-2:s,tilesInst.children[n].translateLocal(0,30,0),sameTile(a[s]),bgmSlots.ClickTile.play()),-1!==n&&states.canDiscard){const i=e.concat(void 0===t?[]:[t]);removeAllFrom(i,[a[s]]),i.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const n=i.join("")+"#"+info.exposed[info.myId].map((e=>e+"_")).join(""),o=states.toLizhi?states.canWLizhi?2:1:0,l=Math.floor(info.round/4),c=(info.myId-info.round+8)%4,r=["4z","5z","6z"].concat(l===c?[`${l}z`]:[`${l}z`,`${c}z`]);r.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const d=r.join("")+"#",h=info.dora.filter((e=>""!==e)).map(nextTile);h.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const f=h.join("")+"#",[m,...p]=tingpai(n,o,l,d,states.zhenting,f).split("+");if(p.length>0){tempTpBg.enabled=!0,tempTpRoot.enabled=!0,tingpaiBack.enabled=!0;const e=p.map((e=>e.split("/")[0]));genTingpai(tempTpRoot,p.map((e=>{const[t,i,n]=e.split("/");return[t,"1"===i,Number(n)]})),e.some((e=>states.discardHistory.some((t=>tileEqual(t,e))))))}else tempTpBg.enabled=!1,tempTpRoot.enabled=!1,tingpaiBack.enabled=!1}else tempTpBg.enabled=!1,tempTpRoot.enabled=!1,tingpaiBack.enabled=!1}));i.setPosition(.08*s-.7,-.9,0),(isRed(a[s])||info.dora.filter((e=>""!==e)).some((e=>tileEqual(a[s],nextTile(e)))))&&i.fire("highlight","dora",!0)}else{const e=createTile(opponentTiles[o],a[s],{dimension:3});e.setPosition(rotateY(new pc.Vec3(20,.7,12-1.7*s),o)),e.rotateLocal(0,90*o,0),(isRed(a[s])||info.dora.filter((e=>""!==e)).some((e=>tileEqual(a[s],nextTile(e)))))&&e.fire("highlight","dora",!0)}}if(gameMode===ONLINE){const i=e.join("")+"#"+info.exposed[info.myId].map((e=>e+"_")).join(""),n=states.toLizhi?states.canWLizhi?2:1:0,o=Math.floor(info.round/4),s=(info.myId-info.round+8)%4,l=["4z","5z","6z"].concat(o===s?[`${o}z`]:[`${o}z`,`${s}z`]);l.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const c=l.join("")+"#",r=info.dora.filter((e=>""!==e)).map(nextTile);r.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const d=r.join("")+"#";let h=e.length%3==2?"0":tingpai(i,n,o,c,states.zhenting,d);if(void 0!==t||states.canDiscard)for(let i=0;i<e.length;++i){const n=e.concat(void 0===t?[]:[t]);removeAllFrom(n,[a[i]]),n.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const o=n.join("")+"#"+info.exposed[info.myId].map((e=>e+"_")).join(""),s=states.toLizhi?states.canWLizhi?2:1:0,l=Math.floor(info.round/4),c=(info.myId-info.round+8)%4,r=["4z","5z","6z"].concat(l===c?[`${l}z`]:[`${l}z`,`${c}z`]);r.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const d=r.join("")+"#",f=info.dora.filter((e=>""!==e)).map(nextTile);f.sort(((e,t)=>tileToSeq(e)-tileToSeq(t)));const m=f.join("")+"#",p=tingpai(o,s,l,d,states.zhenting,m);p.includes("+")&&""!==h&&(h=h!==p&&h.includes("+")?"":p)}if(""!==h){const[e,...t]=h.split("+");t.length>0?tingpaiHint.fire("set",t.map((e=>{const[t,i,n]=e.split("/");return[t,"1"===i,Number(n)]}))):tingpaiHint.fire("unset")}else tingpaiHint.fire("unset")}}const actionToFrame={chi:0,peng:1,gang:2,jiagang:2,angang:2,lizhi:3,zimo:4,hu:5,skip:6,confirm:7};function drawValidActions(e,t,i,n){if(e.includes("hu")||e.includes("chi")||e.includes("peng")){const e=discardedRoots[(info.lastOpPlayer-info.myId+4)%4].children;states.highlightTile=e[e.length-1],states.highlightTile.fire("highlight","active",!0)}for(let o=0;o<e.length;++o){const a=new pc.Entity(e[o]);a.addComponent("element",{type:"image",sprite:actionsSprite.resource,spriteFrame:actionToFrame[e[o]],anchor:new pc.Vec4(.5,.5,.5,.5),pivot:new pc.Vec2(.5,.5),useInput:!0}),a.element.on("click",(()=>{switch(e[o]){case"lizhi":states.toLizhi=!states.toLizhi,a.element.color=states.toLizhi?new pc.Color(0,1,0,1):new pc.Color(1,0,1,1);for(const e of tilesInst.children)e.element.color=!states.toLizhi||lizhiIncluded(states.canLizhi,e.name)?new pc.Color(1,1,1,1):new pc.Color(.3,.3,.3,1);break;case"skip":if(e.includes("lizhi")){states.toLizhi=!1;for(const e of tilesInst.children)e.element.color=!states.toLizhi||lizhiIncluded(states.canLizhi,e.name)?new pc.Color(1,1,1,1):new pc.Color(.3,.3,.3,1);clearActions(!0);break}case"hu":case"zimo":states.canDiscard=!1,countdownInst.fire("unset"),clearActions(!1),states.highlightTile&&(states.highlightTile.fire("highlight","active",!1),states.highlightTile=void 0),sendMsg({type:e[o]});break;case"chi":case"peng":case"gang":case"angang":const s=e[o];let l,c;if(states.canDiscard=!1,clearActions(!1),"chi"===s?(l=states.canChi,c=e=>`C${t.tile}$${e}`):"peng"===s?(l=states.canPeng,c=e=>{const o=(i-n+4)%4;return 1===o?`P${t.tile}$${e}`:2===o?`P${e.slice(0,2)}${t.tile}$${e.slice(2)}`:`P${e}${t.tile}$`}):"gang"===s?(l=states.canGang,c=e=>{const o=(i-n+4)%4;return 1===o?`G${t.tile}$${e}`:2===o?`G${e.slice(0,2)}${t.tile}$${e.slice(2)}`:`G${e}${t.tile}$`}):l=states.canAn,1===l.length){countdownInst.fire("unset");const e=l[0];"angang"===s?angang(i,e):claim(i,s,c(e),naiveSlice(e)),sendMsg({type:s,payload:e}),states.highlightTile=void 0}else{selectImg.enabled=!0;for(let e=0;e<l.length;++e){const t=l[e],n=t.slice(0,2),o=t.slice(2,4),a=100*(e-(l.length-1)/2),{y:r,z:d}=selectImg.localPosition,onclick=()=>{countdownInst.fire("unset"),"angang"===s?angang(i,t):claim(i,s,c(t),[n,o]),sendMsg({type:s,payload:t}),selectImg.enabled=!1,states.highlightTile=void 0,destroyChildren(selectRoot)},h=createTile(selectRoot,n,{dimension:2,isDoraSign:!0},onclick);if(h.element.anchor=new pc.Vec4(.5,.5,.5,.5),h.element.pivot=new pc.Vec2(.5,.5),h.setLocalPosition(a-("angang"===s?0:20),r,d),"angang"!==s){const e=createTile(selectRoot,o,{dimension:2,isDoraSign:!0},onclick);e.element.anchor=new pc.Vec4(.5,.5,.5,.5),e.element.pivot=new pc.Vec2(.5,.5),e.setLocalPosition(a+20,r,d)}}}break;case"jiagang":states.canDiscard=!1,clearActions(!1),countdownInst.fire("unset");for(const e of info.exposed[info.myId])if("P"===e[0]&&tileEqual(info.activeTile,e.slice(1,3))){jiagang(i,"$"===e[7]?`G${e.slice(1,5)}${info.activeTile}$${e.slice(5,8)}`:`G${e.slice(1,6)}${info.activeTile}$${e.slice(6)}`);break}drawMyTiles(info.tiles[info.myId]),sendMsg({type:"jiagang"})}})),a.setLocalScale(5.4,2.7,0),actionsInst.addChild(a),a.setPosition(.6-.3*(e.length-o),-.3,0)}}function redrawExposed(e,t){destroyChildren(exposedRoots[e]);const i=[];let n=-1;for(const e of[...t].reverse())if("C"===e[0]||"P"===e[0]||"G"===e[0]&&2===e.split("$").length){let t=1;for(;t<e.length;)"$"===e[t+2]?(i.push([e.slice(t,t+2),n+1.3,!0,void 0,!1]),n+=1.6,t+=3):(i.push([e.slice(t,t+2),n+1,!1,void 0,!1]),n+=1,t+=2)}else if("G"===e[0]){const t="$"===e[8]?e.slice(0,6)+e.slice(9):e.slice(0,5)+e.slice(8),o="$"===e[8]?e.slice(6,9):e.slice(5,8);let a=1;for(;a<t.length;)"$"===t[a+2]?(i.push([t.slice(a,a+2),n+1.3,!0,o,!1]),n+=1.6,a+=3):(i.push([t.slice(a,a+2),n+1,!1,void 0,!1]),n+=1,a+=2)}else{const t=splitMatch(e);for(let e=0;e<4;++e)i.push([t[e],n+1,!1,void 0,0===e||3===e]),n+=1}for(const[t,o,a,s,l]of i){const i=createTile(exposedRoots[e],t,{dimension:3});if(i.setPosition(rotateY(new pc.Vec3(16+(a?.3:0),.7,1.5*(n-o)-16),e)),i.rotateLocal(0,90*e,0),a&&i.rotateLocal(0,-90,0),s){const t=createTile(exposedRoots[e],s,{dimension:3});t.setPosition(rotateY(new pc.Vec3(14.6,.7,1.5*(n-o)-16),e)),t.rotateLocal(0,90*e-90,0)}l&&i.rotateLocal(0,0,180),(isRed(t)||info.dora.filter((e=>""!==e)).some((e=>tileEqual(t,nextTile(e)))))&&i.fire("highlight","dora",!0)}}function visualizePoint(e,t,i){destroyChildren(pointsInsts[e]);const n=(i&&t>0?"+":"")+String(t),o=i?t>0?12:0:24;for(var a=0;a<n.length;++a){const t=.7*(a-(n.length-1)/2),i=new pc.Entity(n[a]);i.addComponent("sprite",{sprite:scoreSprite.resource,frame:o+("-"===n[a]?0:"+"===n[a]?1:2+Number(n[a]))}),i.setLocalScale(5,5,1),i.setLocalPosition(t,0,0),pointsInsts[e].addChild(i)}}function updatePoints(e,t){for(let i=0;i<4;++i)visualizePoint((i-info.myId+4)%4,e[i],!0===t&&i!==info.myId)}function updateRemaining(e){leftOnesInst.sprite.frame=e%10,leftTensInst.sprite.frame=Math.floor(e/10)}function visualizeDora(e,t){const i=t?liDoraRoot:doraBoard;destroyChildren(i),e.forEach(((e,n)=>{createTile(i,e,{dimension:2,isDoraSign:!0}).setPosition(.064*n-.95,t?.25:.74,0),sameTile(nextTile(e),"dora")}))}function visualizeChangGong([e,t]){t<10?(jibang1.enabled=!1,jibang0.element.spriteFrame=t):(jibang1.enabled=!0,jibang1.element.spriteFrame=t%10,jibang0.element.spriteFrame=Math.floor(t/10)),e<10?(benchang1.enabled=!1,benchang0.element.spriteFrame=e):(benchang1.enabled=!0,benchang1.element.spriteFrame=e%10,benchang0.element.spriteFrame=Math.floor(e/10))}function visualizePopActive(e){const t=discardedRoots[e].children;t.length-1===states.lizhiPos[e]&&(states.lizhiPos[e]=-1),t[t.length-1].destroy()}function visualizePushActive(e,t,i,n){const o=discardedRoots[e].children.length,a=Math.min(Math.floor(o/6),2),s=o-6*a,l=Math.min(Math.floor(states.lizhiPos[e]/6),2)===a?.7:i?.35:0;i&&(states.lizhiPos[e]=o);const c=createTile(discardedRoots[e],t,{dimension:3});c.setPosition(rotateY(new pc.Vec3(8+2.4*a,.7,4.5-1.8*s-l),e)),c.rotateLocal(0,90*e,0),i&&c.rotateLocal(0,-90,0),(isRed(t)||info.dora.filter((e=>""!==e)).some((e=>tileEqual(t,nextTile(e)))))&&c.fire("highlight","dora",!0),n&&c.fire("highlight","moqie",!0)}function clearDiscarded(e){destroyChildren(discardedRoots[e])}function visualizeOver(e,t){for(let e=0;e<4;++e)destroyChildren(tingPaiRoot.children[e]),destroyChildren(liDoraRoot),destroyChildren(huPaiXingRoot),yakumanChars[e].enabled=!1;for(let e=0;e<5;++e)yiTextL.children[e].enabled=yiTextL.children[e+5].enabled=!1,yiTextR.children[e].enabled=yiTextR.children[e+5].enabled=!1,yiTextX.children[e].enabled=yiTextX.children[e+5].enabled=!1;yiTextL.element.text="",yiTextR.element.text="",yiTextX.element.text="",liDoraText.enabled=void 0!==e.li_doras,fuFanRoot.enabled=void 0!==e.yizhong&&e.total_fans<=12,yakumanWord.enabled=e.total_fans>=13,huangpaiPic.enabled=e.huangpai,resultScreen.enabled=!0,drawMyTiles(info.tiles[info.myId],e.huangpai||info.lastOpPlayer!==info.myId?void 0:info.activeTile);for(let n=0;n<4;++n){const o=(n-t.myId+4)%4;destroyChildren(pointsDiff.children[2*o]),t.points[n]+=e.points[n];const a=String(t.points[n]);for(var i=0;i<a.length;++i){const e=22*(i-(a.length-1)),{x:t,y:n,z:s}=pointsDiff.children[2*o].localPosition,l=new pc.Entity(a[i]);l.addComponent("element",{type:"image",sprite:pointsNumInst.resource,spriteFrame:"-"===a[i]?10:Number(a[i]),pivot:new pc.Vec2(.5,.5),anchor:new pc.Vec4(.5,.5,.5,.5)}),l.setLocalScale(.7,1.1,1),l.setLocalPosition(e+t,n,s),pointsDiff.children[2*o].addChild(l)}pointsDiff.children[2*o+1].element.text=e.points[n]<0?String(e.points[n]):`+${e.points[n]}`,pointsDiff.children[2*o+1].element.color=e.points[n]>0?pc.Color.GREEN:e.points[n]<0?pc.Color.RED:pc.Color.WHITE}if(e.huangpai)for(let i=0;i<4;++i){const n=e.listen_cards[i];if(n&&n.length>0){const e=(i-t.myId+4)%4;for(let t=0;t<n.length;++t){const i=createTile(tingPaiRoot.children[e],n[t],{dimension:2,isDoraSign:!0});i.element.anchor=new pc.Vec4(.5,.5,.5,.5),i.element.pivot=new pc.Vec2(.5,.5);const{x:o,y:a,z:s}=tingPaiRoot.children[e].localPosition;i.setLocalPosition(o+40*(t-(n.length-1)/2),a,s)}}}if(e.li_doras&&visualizeDora(e.li_doras.concat(Array.from(new Array(5-e.li_doras.length),(()=>""))),!0),e.hu_cards){const t=e.hu_cards;let i,n,o;switch(t[0]){case"D":{const e=t.indexOf("!");e>-1?(i=batchSlice(t.slice(3,e-2)+t.slice(e+1,t.length-1)),o=[t.slice(e-2,e)]):(i=batchSlice(t.slice(3,t.length-1)),o=[]),n=[];break}case"G":{const e=t.slice(5,7),a=t.slice(t.length-4,t.length-2);i=batchSlice("1m9m1p9p1s9s0z1z2z3z4z5z6z".replace(e,e+e).replace(a,"")),n=[],o=[a];break}case"M":{let e=t.slice(3).replaceAll("$","").replaceAll("_","").replaceAll("C","").replaceAll("P","").replaceAll("G","").replaceAll("Q","").replaceAll("%","");for(;e.includes("A");){const t=e.indexOf("A");e=e.slice(0,t)+splitMatch(e.slice(t,t+3)).join("")+e.slice(t+3)}const[a,s]=e.split("#"),l=a.indexOf("!");l>-1?(i=batchSlice(a.slice(0,l-2)+a.slice(l+1)),o=[a.slice(l-2,l)]):(i=batchSlice(a),o=[]),n=batchSlice(s);break}}let a=-(i.length+n.length+o.length-(0===n.length?0:.5)-(0===o.length?0:.5))/2;const{x:s,y:l}=huPaiXingRoot.localPosition,add=e=>{const t=createTile(huPaiXingRoot,e,{dimension:2});t.element.anchor=new pc.Vec4(.5,.5,.5,.5),t.element.pivot=new pc.Vec2(.5,.5),t.setLocalPosition(s+50*a,l,0),a+=1};i.forEach(add),n.length>0&&(a+=.5,n.forEach(add)),o.length>0&&(a+=.5,o.forEach(add))}if(e.yizhong){const t=Object.keys(e.yizhong).map((t=>[t,e.yizhong[t]])),dumpText=(e,i)=>{const n=t.slice(5*e,5*e+5).map((([e,t])=>yiDict[e]));i.element.text=n.concat(Array.from(new Array(5-n.length),(()=>" "))).join("\n")};dumpText(0,yiTextL),dumpText(1,yiTextR),dumpText(2,yiTextX);const writeFan=(e,i,n)=>{e+5*i<t.length&&t[e+5*i][1]<=6?(n.children[e].enabled=n.children[e+5].enabled=!0,n.children[e].element.spriteFrame=t[e+5*i][1]):n.children[e].enabled=n.children[e+5].enabled=!1};for(let e=0;e<5;++e)writeFan(e,0,yiTextL),writeFan(e,1,yiTextR),writeFan(e,2,yiTextX);t.length>10?(yiTextL.setLocalPosition(-156,220,0),yiTextR.setLocalPosition(136,220,0),yiTextX.setLocalPosition(428,220,0)):(yiTextL.setLocalPosition(-96,220,0),yiTextR.setLocalPosition(276,220,0));const dumpNumber=(e,t)=>{const[i,n,o]=fuFanRoot.children.slice(t);i.enabled=e>=100,i.element.spriteFrame=Math.floor(e/100),n.enabled=e>=10,n.element.spriteFrame=Math.floor(e/10)%10,o.enabled=!0,o.element.spriteFrame=e%10};if(dumpNumber(e.total_fans,4),dumpNumber(e.total_fus,0),e.total_fans>14){const t=Math.round(e.total_fans/14);yakumanChars[0].element.spriteFrame=2===t?9:2+t,yakumanChars[1].element.spriteFrame=10,yakumanChars[2].element.spriteFrame=13,yakumanChars[3].element.spriteFrame=4;for(let e=0;e<4;++e)yakumanChars[e].enabled=!0}else if(11<=e.total_fans&&e.total_fans<=12){yakumanChars[1].element.spriteFrame=5,yakumanChars[2].element.spriteFrame=10,yakumanChars[3].element.spriteFrame=4;for(let e=1;e<4;++e)yakumanChars[e].enabled=!0}else 8<=e.total_fans&&e.total_fans<=10?(yakumanChars[1].element.spriteFrame=10,yakumanChars[2].element.spriteFrame=4,yakumanChars[1].enabled=!0,yakumanChars[2].enabled=!0):6<=e.total_fans&&e.total_fans<=7?(yakumanChars[1].element.spriteFrame=3,yakumanChars[2].element.spriteFrame=4,yakumanChars[1].enabled=!0,yakumanChars[2].enabled=!0):(3===e.total_fans&&e.total_fus>=70||4===e.total_fans&&e.total_fus>=40||5===e.total_fans)&&(yakumanChars[1].element.spriteFrame=4,yakumanChars[2].element.spriteFrame=11,yakumanChars[1].enabled=!0,yakumanChars[2].enabled=!0)}}const info={round:1,myId:0,changGong:[0,0],points:[25e3,25e3,25e3,25e3],remaining:70,lizhi:[!1,!1,!1,!1],tiles:[[],[],[],[]],discarded:[[],[],[],[]],exposed:[[],[],[],[]],dora:["","","","",""],activeTile:"",activePlayer:0,lastOpPlayer:-1},states={canDiscard:!1,toLizhi:!1,canLizhi:[],canChi:[],canPeng:[],canGang:[],canAn:[],highlightTile:void 0,lizhiPos:[-1,-1,-1,-1],zhenting:!1,someoneLizhi:!1,nowTingpai:[],canWLizhi:!0,discardHistory:[]};function popFromDiscarded(i,e=!0){info.discarded[i].pop(),e&&visualizePopActive((i-info.myId+4)%4)}function pushToDiscarded(i,e,n,o,a=!0){info.discarded[i].push([e,n,o]),a&&visualizePushActive((i-info.myId+4)%4,e,n,o)}function removeAllFrom(i,e){for(const n of e){const e=i.indexOf(n);e>-1&&i.splice(e,1)}}function onlineInit({round:i,myId:e,changGong:n,points:o,myTiles:a,firstDora:s},t=!0){if(info.round=i,info.myId=e,info.changGong=n,info.points=o,info.remaining=70,info.lizhi=[!1,!1,!1,!1],info.discarded=[[],[],[],[]],info.exposed=[[],[],[],[]],info.dora=[s,"","","",""],resultScreen.enabled=!1,zhentingImg.enabled=!1,tingpaiHint.enabled=!1,t){if(info.tiles[e]=a,13===a.length)drawMyTiles(a);else{const i=a[13];a.pop(),newTile(i)}visualizeDora(info.dora),visualizeChangGong(info.changGong),updatePoints(info.points),updateRemaining(info.remaining),visualizeFeng(info.round,info.myId),changFengInst.sprite.frame=info.round<4?0:1,juNumInst.sprite.frame=info.round%4,bgmSlots.NewRoundShowTiles.play()}for(var l=0;l<4;++l)redrawExposed(l,[]),clearDiscarded(l),lizhibangRoot.children[l].enabled=!1;states.someoneLizhi&&(bgmSlots.Lizhi.stop(),bgmSlots.Game.play()),states.canDiscard=!1,states.toLizhi=!1,states.canLizhi=[],states.canChi=[],states.canPeng=[],states.canGang=[],states.canAn=[],states.highlightTile=void 0,states.lizhiPos=[-1,-1,-1,-1],states.zhenting=!1,states.someoneLizhi=!1,states.nowTingpai=[],states.canWLizhi=!0,states.discardHistory=[],centerCollider.on("click",(()=>{const i=[...info.points];for(let e=0;e<4;++e)e!==info.myId&&(i[e]-=i[info.myId]);updatePoints(i,!0),setTimeout((()=>{updatePoints(info.points)}),5e3)}))}function discard(i,e,n,o,a,s=!0){n||(removeAllFrom(info.tiles[i],[e]),a||info.tiles[i].push(info.activeTile),info.activeTile=e),s&&(drawMyTiles(info.tiles[i],void 0,i),gameMode!==OFFLINE&&i!==info.myId||bgmSlots.DiscardTile.play()),pushToDiscarded(i,e,o,n,s),gameMode===ONLINE&&i===info.myId&&(states.discardHistory.push(e),states.canWLizhi=!1)}function claim(i,e,n,o,a=!0){popFromDiscarded(info.activePlayer,a),removeAllFrom(info.tiles[i],o),info.exposed[i].push(n),a&&(redrawExposed((i-info.myId+4)%4,info.exposed[i]),drawMyTiles(info.tiles[i],void 0,i),bgmSlots.Fulu.play()),gameMode===ONLINE&&i===info.myId&&(states.canWLizhi=!1)}function jiagang(i,e,n=!0){const o="P"+("$"===e[10]?e.slice(1,5)+e.slice(8,11):e.slice(1,6)+e.slice(9,11)),a=info.exposed[i].indexOf(o);a>-1?info.exposed[i][a]=e:info.exposed[i].push(e),n&&(redrawExposed((i-info.myId+4)%4,info.exposed[i]),bgmSlots.Fulu.play()),gameMode===ONLINE&&i===info.myId&&(states.canWLizhi=!1)}function angang(i,e,n=!0){const o="5"===e[0]&&"z"!==e[1]?"0"+e[1]:e;info.tiles[i].push(info.activeTile),removeAllFrom(info.tiles[i],[o,e,e,e]),info.exposed[i].push("A"+e),n&&(redrawExposed((i-info.myId+4)%4,info.exposed[i]),drawMyTiles(info.tiles[i],void 0,i),bgmSlots.Fulu.play()),gameMode===ONLINE&&i===info.myId&&(states.canWLizhi=!1)}function newTile(i,e=info.myId,n=!0){info.activeTile=i,info.activePlayer=e,--info.remaining,n&&(drawMyTiles(info.tiles[e],i,e),updateRemaining(info.remaining)),gameMode===ONLINE&&(info.lastOpPlayer=e)}function prepareAction(i,e){if(1===i.length&&"skip"===i[0])setTimeout((()=>{discard(info.myId,info.activeTile,!0,!1,!1),sendMsg({type:"skip"})}),800);else{const n=info.activeTile,o=i.includes("qiepai");countdownInst.fire("set",e.time,(()=>{if(states.canDiscard=!1,o){const i=info.tiles[info.myId].length%3==2;discard(info.myId,i?info.tiles[info.myId][0]:n,!i,!1,i)}destroyChildren(actionsInst),destroyChildren(selectRoot),selectImg.enabled=!1,states.highlightTile&&(states.highlightTile.fire("highlight","active",!1),states.highlightTile=void 0)})),i.includes("qiepai")&&(states.canDiscard=!0,removeAllFrom(i,["qiepai"])),i.includes("lizhi")&&!i.includes("skip")&&i.push("skip"),i.length>0&&bgmSlots.BtnAppear.play(),states.canLizhi=e.lizhi?e.lizhi:[],states.canChi=e.chi?e.chi:[],states.canPeng=e.peng?e.peng:[],states.canGang=e.gang?e.gang:[],states.canAn=e.angang?e.angang:[],drawValidActions(i,e,info.myId,info.activePlayer)}}function opponentAction(i,e,n,o,a=!0,s=!1){switch(e){case"qiepai":case"lizhi":info.activePlayer=i,gameMode===ONLINE&&(info.activeTile=n),discard(i,n,o,"lizhi"===e,s||gameMode===OFFLINE&&info.lastOpPlayer===i,a),gameMode===OFFLINE&&(info.activeTile=n),info.lastOpPlayer!==i&&(gameMode===ONLINE&&--info.remaining,a&&updateRemaining(info.remaining));break;case"chi":case"peng":case"gang":claim(i,e,n,splitMatch(n),a);break;case"jiagang":jiagang(i,n,a);break;case"angang":angang(i,n.slice(1),a)}info.lastOpPlayer=i}function lizhi(i,e=!0){info.points[i]-=1e3,info.lizhi[i]=!0,++info.changGong[1],e&&(updatePoints(info.points),visualizeChangGong(info.changGong)),lizhibangRoot.children[(i-info.myId+4)%4].enabled=!0,states.someoneLizhi||(states.someoneLizhi=!0,bgmSlots.Game.stop(),bgmSlots.Lizhi.play())}function revealDora(i,e=!0){info.dora[info.dora.indexOf("")]=i,e&&(visualizeDora(info.dora),bgmSlots.NewDora.play())}function handleOver(i){visualizeOver(i,info)}function handleZhenting(i,e=!0){states.zhenting=i,e&&(zhentingImg.enabled=i)}var PickerRaycast=pc.createScript("pickerRaycast");PickerRaycast.prototype.initialize=function(){const{touch:t,mouse:e,systems:c}=this.app,{camera:i}=this.entity;t&&t.on(pc.EVENT_TOUCHEND,(({event:t})=>t.preventDefault())),e.on(pc.EVENT_MOUSEDOWN,(({x:t,y:e})=>{const r=i.screenToWorld(t,e,i.nearClip),a=i.screenToWorld(t,e,i.farClip),s=c.rigidbody.raycastFirst(r,a);s&&s.entity.fire("click")}))};var Fullscreen=pc.createScript("fullscreen");Fullscreen.prototype.initialize=function(){this.entity.element.on("click",(function(e){this.app.enableFullscreen(null)}),this)};function drawFrame(e){cameraRoot.enabled=!0;let a=e;for(;0!==replay[a].type;)--a;const n=replay[a].info;onlineInit({round:n.round,myId:observerId,changGong:[...n.changGong],points:[...n.points],myTiles:[...replay[a].info.tiles[observerId]],firstDora:n.firstDora},!1);for(let e=0;e<4;++e)info.tiles[e]=[...replay[a].info.tiles[e]];for(--info.remaining;a<e;){++a;const e=replay[a];switch(e.type){case 1:newTile(e.tile,e.actionPlayer,!1);break;case 2:const n=0===replay[a-1].type&&14===replay[a-1].info.tiles[e.actionPlayer].length;opponentAction(e.actionPlayer,e.actionType,e.actionPayload,e.moqie,!1,n);break;case 3:revealDora(e.tile,!1);break;case 5:break;case 6:lizhi(e.player,!1);break;case 7:e.player===observerId&&handleZhenting(e.is_zhenting,!1)}}visualizeDora(info.dora),visualizeChangGong(info.changGong),updatePoints(info.points),updateRemaining(info.remaining),visualizeFeng(info.round,info.myId),zhentingImg.enabled=states.zhenting;for(let e=0;e<4;++e)drawMyTiles(info.tiles[e],1===replay[a].type&&replay[a].actionPlayer===e?replay[a].tile:void 0,e);changFengInst.sprite.frame=info.round<4?0:1,juNumInst.sprite.frame=info.round%4;for(let e=0;e<4;++e){redrawExposed((e-observerId+4)%4,info.exposed[e]);for(const[a,n,i]of info.discarded[e])visualizePushActive((e-observerId+4)%4,a,n,i)}5===replay[a].type&&handleOver(replay[a].info)}function drawFrameFromDiff(e){const a=replay[e];switch(a.type){case 0:return void drawFrame(e);case 1:newTile(a.tile,a.actionPlayer);break;case 2:const n=0===replay[e-1].type&&14===replay[e-1].info.tiles[a.actionPlayer].length;opponentAction(a.actionPlayer,a.actionType,a.actionPayload,a.moqie,!0,n);break;case 3:revealDora(a.tile);break;case 5:handleOver(a.info);break;case 6:lizhi(a.player);break;case 7:a.player===observerId&&handleZhenting(a.is_zhenting)}}var ChangeObserver=pc.createScript("changeObserver");ChangeObserver.attributes.add("diff",{type:"number"}),ChangeObserver.prototype.initialize=function(){this.entity.element.on("click",(()=>{observerId=(observerId+this.diff)%4,loadFrame(currFrame)}))};var Tingpai=pc.createScript("tingpai");Tingpai.attributes.add("background",{type:"entity"}),Tingpai.attributes.add("cardsRoot",{type:"entity"});const countRemaining=e=>{let t=0;for(let n=0;n<4;++n){for(const o of discardedRoots[n].children)tileEqual(e,o.name)&&++t;for(const o of exposedRoots[n].children)tileEqual(e,o.name)&&++t}for(const n of tilesInst.children)tileEqual(e,n.name)&&++t;for(const n of info.dora.filter((e=>""!==e)))tileEqual(e,n)&&++t;return 4-t};function genTingpai(e,t,n=!1){destroyChildren(e);for(let o=0;o<t.length;++o){const i=o-(t.length-1)/2,[c,a,l]=t[o],s=createTile(e,c,{dimension:2,isDoraSign:!0});if(s.element.anchor=new pc.Vec4(.5,.5,.5,.5),s.element.pivot=new pc.Vec2(.5,.5),s.setLocalPosition(50*i,-120,0),a){const t=new pc.Entity;t.addComponent("element",{type:"image",texture:fanImg.resource}),t.setLocalPosition(50*i+10,-165,0),t.setLocalScale(.6,.6,1),t.element.anchor=new pc.Vec4(.5,.5,.5,.5),t.element.pivot=new pc.Vec2(.5,.5),e.addChild(t);const n=String(l);for(let t=0;t<n.length;++t){const o=new pc.Entity;o.addComponent("element",{type:"image",sprite:fanNumSprite.resource,spriteFrame:Number(n[t])}),o.setLocalPosition(50*i-10+10*(t-(n.length-1)/2),-165,0),o.setLocalScale(.32,.5,1),o.element.anchor=new pc.Vec4(.5,.5,.5,.5),o.element.pivot=new pc.Vec2(.5,.5),e.addChild(o)}}else{const t=new pc.Entity;t.addComponent("element",{type:"image",texture:wuyiImg.resource}),t.setLocalPosition(50*i,-165,0),t.setLocalScale(1.2,.6,1),t.element.anchor=new pc.Vec4(.5,.5,.5,.5),t.element.pivot=new pc.Vec2(.5,.5),e.addChild(t)}const d=String(countRemaining(c)),r=new pc.Entity(d);if(r.addComponent("element",{type:"text",text:d,font:defaultFont.resource,fontSize:20,color:pc.Color.BLACK}),r.setLocalPosition(50*i+10,-100,0),r.element.anchor=new pc.Vec4(.5,.5,.5,.5),r.element.pivot=new pc.Vec2(.5,.5),e.addChild(r),n){const t=new pc.Entity("zhenting");t.addComponent("element",{type:"image",color:pc.Color.RED,pivot:new pc.Vec2(.5,.5),anchor:new pc.Vec4(.5,.5,.5,.5)}),t.setLocalPosition(50*i,-75,0),t.setLocalScale(1.4,.6,0),e.addChild(t);const n=new pc.Entity("zhentingWord");n.addComponent("element",{type:"text",color:pc.Color.WHITE,font:zhentingFont.resource,fontSize:20,text:"振听",pivot:new pc.Vec2(.5,.5),anchor:new pc.Vec4(.5,.5,.5,.5)}),n.setLocalPosition(50*i,-75,0),e.addChild(n)}}}Tingpai.prototype.initialize=function(){this.entity.on("set",(e=>{this.entity.enabled=!0,this.background.enabled=!1,this.cardsRoot.enabled=!1,genTingpai(this.cardsRoot,e,states.zhenting)})),this.entity.on("unset",(()=>{this.entity.enabled=!1,this.background.enabled=!1,this.cardsRoot.enabled=!1})),this.entity.element.on("mousedown",(()=>{this.background.enabled=!0,this.cardsRoot.enabled=!0,tempTpBg.enabled=!1,tempTpRoot.enabled=!1})),this.entity.element.on("mouseup",(()=>{this.background.enabled=!1,this.cardsRoot.enabled=!1})),this.entity.element.on("mouseleave",(()=>{this.background.enabled=!1,this.cardsRoot.enabled=!1}))};